load("@rules_go//go:def.bzl", "go_binary", "go_library")

go_library(
    name = "build_lib",
    srcs = ["main.go"],
    importpath = "github.com/louisbuchbinder/core/louisbuchbinder.com/build",
    visibility = ["//visibility:private"],
    deps = [
        "//lib/util",
        "//louisbuchbinder.com/build/load",
        "//louisbuchbinder.com/build/wasm_playground",
        "//louisbuchbinder.com/templates",
    ],
)

genrule(
    name = "site",
    srcs = ["//louisbuchbinder.com:manifest.json"],
    outs = [
        ":site.tar",
    ],
    cmd = """
    mkdir site
    BUILD=$$(realpath $(location :build))
    MANIFEST=$$(realpath $(location //louisbuchbinder.com:manifest.json))
    cd site
    $$BUILD --manifest $$MANIFEST
    find . -type f | xargs tar -cf ../$(location :site.tar)
    """,
    tools = [":build"],
    visibility = ["//visibility:public"],
)

go_binary(
    name = "build",
    embed = [":build_lib"],
    visibility = ["//visibility:public"],
)
